<%= hidden_field_tag 'user_textfilter', current_user.text_filter_name %>
<div id="autosave">
  <%= hidden_field_tag('article[id]', @article.id) if @article.present? %>
</div>
<div class="row save-bar">
  <div class="col-lg-8 offset-lg-2 d-flex justify-content-end" id="save-bar">
    <div>
      <%= link_to(t('.cancel'), { action: 'index' }, { class: 'btn btn-default' }) %>
      <span id="preview_link">
        <%= link_to(t('.preview'), { controller: '/articles', action: 'preview', id: @article.id }, { target: 'new', class: 'btn btn-default' }) if @article.id %>
      </span>
      <input id="save_draft" type="submit" value="<%= t('.save_as_draft') %>" name="article[draft]" class="btn btn-secondary">
      <!-- Button trigger modal -->
      <button class="btn btn-success" data-toggle="modal" type="button" data-target="#publishOptions">
        <%= controller.action_name == 'new' ? t('.publish') : t('.save') %>
      </button>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8 offset-lg-2" id="error-message-article">
    <%= render 'shared/flash', flash: flash %>
    <% if @article.errors.any? %>
      <div id="error_explanation">
        <h2><%= t("errors.template.header", model: 'article', count: @article.errors.count) %></h2>
        <p><%= t("errors.template.body") %></p>
        <ul>
          <% @article.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>
</div>

<div class="row">
  <div class="col-lg-2" id="quicktags-block">
    <div id="quicktags" class="float-right">
      <script type="text/javascript">edToolbar('article_body_and_extended', '<%= @article.text_filter_name %>');</script>
    </div>
  </div>
  <div class="col-lg-8">
    <%= text_field 'article', 'title', class: 'form-control', placeholder: t('.title') %>
    <div id="editor">
      <%= text_area('article', 'body_and_extended', class: 'form-control ', style: 'height: 360px', placeholder: t('.type_your_post')) %>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="publishOptions" tabindex="-1" role="dialog" aria-labelledby="publishTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="publishTitle">
          <%= t('.publish') %>
          <%= submit_tag(t('.publish'), class: 'btn btn-success pull-right') %>
        </h2>
      </div>
      <div class="modal-body">
        <div class="card mb-3">
          <div class="card-body">
            <h4 class="card-title"><%= t('.tags') %></h4>
            <div class="form-group">
              <%= text_field 'article', 'keywords', autocomplete: 'off', class: 'form-control tm-input' %>
            </div>
            <p class="alert alert-warning"><%= t('.tags_explanation_html') %></p>
          </div>
        </div>

        <% post_types = @post_types || [] %>
        <% if post_types.size.zero? %>
          <%= hidden_field_tag 'article[post_type]', 'read' %>
        <% else %>
          <div class="card mb-3">
            <div class="card-body">
              <h4 class="card-title"><%= t('.article_type') %></h4>
              <%= select :article, :post_type, post_types.map { |pt| [pt.name, pt.permalink] }, include_blank: t('.default') %>
            </div>
          </div>
        <% end %>

        <div class="card">
          <div class="card-body">
            <fieldset>
              <legend><%= t('.publish_settings') %></legend>
              <div class='control-group'>
                <p>
                <%= t('.permalink') %>:
                <%= toggle_element('permalink') %>
                </p>
                <div id="permalink" class="collapse">
                  <div class="form-group">
                    <%= text_field 'article', 'permalink', autocomplete: 'off', class: 'form-control' %>
                  </div>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element('permalink', t('.ok')) %>
                  </span>
                  </p>
                </div>
              </div>
              <div class="control-group">
                <p>
                <%= t('.status') %>: <strong><%= @article.state.to_s.downcase %></strong>
                <%= toggle_element('status') %>
                </p>
                <div id="status" class="collapse">
                  <label for="article_published" class="checkbox">
                    <%= check_box 'article', 'published?' %>
                    <%= t('.published') %>
                  </label>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element 'status', t('.ok') %>
                  </span>
                  </p>
                </div>
              </div>
              <div class="control-group">
                <p>
                <%= t('.allowed_comments_html', allow_comment: content_tag(:strong, @article.allow_comments? ? t('.allow_comments_status.enabled') : t('.allow_comments_status.disabled'))) %>
                <%= toggle_element('conversation') %>
                </p>
                <div id="conversation" class="collapse">
                  <label for="article_allow_comments" class="checkbox">
                    <%= check_box 'article', 'allow_comments' %>
                    <%= t('.allow_comments') %>
                  </label>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element('conversation', t('.ok')) %>
                  </span>
                  </p>
                </div>
              </div>
              <div class="control-group">
                <p>
                <%= t('.published') %>
                <strong>
                  <% if @article.published_at.present? %>
                    <%= display_date_and_time(@article.published_at) %>
                  <% else %>
                    <%= t('.now') %>
                  <% end %>
                </strong>
                <%= toggle_element('publish') %>
                </p>
                <div id="publish" class="collapse">
                  <%= datetime_field 'article', 'published_at' %>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element('publish', t('.ok')) %>
                  </span>
                  </p>
                </div>
              </div>
              <div class="control-group">
                <p>
                <%= t('.visibility') %>: <strong><%= @article.password.blank? ? t('.public') : t('.protected') %></strong>
                <%= toggle_element('visibility') %>
                </p>
                <div id="visibility" class="collapse">
                  <label for="article_password"><%= t('.password') %></label>
                  <%= text_field 'article', 'password', class: 'form-control' %>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element('visibility', t('.ok')) %>
                  </span>
                  </p>
                </div>
              </div>
              <div class="control-group">
                <p>
                <%= t('.article_filter') %>: <strong><%= @article.text_filter.description %></strong>
                <%= toggle_element 'text_filter' %>
                </p>
                <div id="text_filter" class="collapse">
                  <select name="article[text_filter_name]" id="text_filter_name" class='form-control'>
                    <%= options_for_select text_filter_options, @article.text_filter_name %>
                  </select>
                  <p>
                  <span class="btn btn-mini btn-secondary">
                    <%= toggle_element 'text_filter', 'OK' %>
                  </span>
                  </p>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal"><%= t('.cancel') %></button>
        <%= submit_tag(t('.publish'), class: 'btn btn-success') %>
      </div>
    </div>
  </div>
</div>
